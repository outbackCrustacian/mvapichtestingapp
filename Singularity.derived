Bootstrap: shub
From: jtchilders/singularity_mpi_test_recipe:latest

%setup
   # make directory for test MPI program
   mkdir ${SINGULARITY_ROOTFS}/testmvapich
   # cp pi.c ${SINGULARITY_ROOTFS}/testmvapich/

%post
   yum install -y wget
   # add to local environment to build pi.c
   export PATH=$PATH:/mpich/install/lib
   export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/mpich/install/lib
   env | sort
   cd /testmvapich
   wget -q http://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-5.4.2.tar.gz
   tar xf osu-micro-benchmarks-5.4.2.tar.gz --strip-components=1

   ./configure CC=/mpich/install/bin/mpicc CXX=/mpich/install/bin/mpicxx --prefix=/usr
	make
	make install

#how to run apps in vagrant
#Install mpi inside vagrent (follow the singularity.mpich)
#Command something like this: mpirun -n 2 singularity run --app latency

#Point To Point MPI Benchmarks
#
#
##############################
# latency
##############################
%apprun latency
   # run the command to perform a latency test
   /usr/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_latency



##############################
# bandwith
##############################
%apprun bandwith
   # run the command to perform a bandwith test
   /usr/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_bw




##############################
# latency_mt
##############################
%apprun latency_mt
   # run the command to perform a multi threaded latency test
   /usr/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_latency_mt



##############################
# bibw
##############################
%apprun bibw
   #run the command to perform a bidirectional bandwith test
   /usr/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_bibw



##############################
# mbw_mr
##############################
%apprun mbw_mr
   #run the command to perform a multiple bandwith / messaging rate test
   /usr/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_mbw_mr



##############################
# multi_lat
##############################
%apprun multi_lat
   #run the command to perform a multi pair latency test
   /usr/libexec/osu-micro-benchmarks/mpi/pt2pt/osu_multi_lat









#Collective MPI Benchmarks
#
#
#00000000000000000000000000000
#allcollectives
#00000000000000000000000000000
%apprun allcollectives
   #run every benchmark included in the collective library
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_allgather
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_allgatherv
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_allreduce
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_alltoall
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_alltoallv
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_barrier
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_bcast
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_gather
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_gatherv
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_reduce
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_reduce_scatter
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_scatter
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_scatterv


#00000000000000000000000000000
# allgather
#00000000000000000000000000000
%apprun allgather
   #run an MPI allgather latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_allgather


#00000000000000000000000000000
# allgatherv
#00000000000000000000000000000
%apprun allgatherv
   #run an MPI allgatherv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_allgatherv


#00000000000000000000000000000
#allreduce
#00000000000000000000000000000
%apprun allreduce
   #run an MPI allreduce latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_allreduce


#00000000000000000000000000000
#alltoall
#00000000000000000000000000000
%apprun alltoall
   #run an MPI alltoall latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_alltoall


#00000000000000000000000000000
#alltoallv
#00000000000000000000000000000
%apprun alltoallv
   #run an MPI alltoallv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_alltoallv


#00000000000000000000000000000
#barrier
#00000000000000000000000000000
%apprun barrier
   #run an MPI barrier latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_barrier


#00000000000000000000000000000
#bcast
#00000000000000000000000000000
%apprun bcast
   #run an MPI bcast latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_bcast


#00000000000000000000000000000
#gather
#00000000000000000000000000000
%apprun gather
   #run an MPI gather latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_gather


#00000000000000000000000000000
#gatherv
#00000000000000000000000000000
%apprun gatherv
   #run an MPI gatherv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_gatherv


#00000000000000000000000000000
#reduce
#00000000000000000000000000000
%apprun reduce
   #run an mpi reduce latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_reduce


#00000000000000000000000000000
#reduce_scatter
#00000000000000000000000000000
%apprun reduce_scatter
   #run an mpi reduce_scatter latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_reduce_scatter


#00000000000000000000000000000
#scatter
#00000000000000000000000000000
%apprun scatter
   #run an mpi scatter latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_scatter


#00000000000000000000000000000
#scatterv
#00000000000000000000000000000
%apprun scatterv
   #run an mpi scatterv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_scatterv









#Non blocking collective MPI benchmarks
#
#
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#allnonblocking
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun allnonblocking
   #run every benchmark included in the collective library
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iallgather
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iallgatherv
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ialltoall
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ialltoallv
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ibarrier
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ibcast
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_igather
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_igatherv
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iscatter
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iscatterv


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# iallgather
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun iallgather
   #run an MPI iallgather latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iallgather


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
# iallgatherv
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun iallgatherv
   #run an MPI iallgatherv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iallgatherv


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#ialltoall
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun ialltoall
   #run an MPI ialltoall latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ialltoall


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#ialltoallv
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun ialltoallv
   #run an MPI ialltoallv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ialltoallv


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#ialltoallw
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun ialltoallw
   #run an MPI ialltoallw latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ialltoallw


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#ibarrier
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun ibarrier
   #run an MPI ibarrier latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ibarrier


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#ibcast
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun ibcast
   #run an MPI ibcast latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_ibcast


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#igather
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun igather
   #run an MPI igather latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_igather


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#igatherv
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun igatherv
   #run an MPI igatherv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_igatherv


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#iscatter
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun iscatter
   #run an mpi iscatter latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iscatter


#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
#iscatterv
#XXXXXXXXXXXXXXXXXXXXXXXXXXXXX
%apprun iscatterv
   #run an mpi iscatterv latency benchmark
   /usr/libexec/osu-micro-benchmarks/mpi/collective/osu_iscatterv